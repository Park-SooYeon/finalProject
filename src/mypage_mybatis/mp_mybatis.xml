<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTDMapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mypage">
	
	<resultMap id="mp_map_like" type="bean.LikeListVo">
		<result column="like_serial" property="like_serial"/>
		<result column="member_id" property="member_id"/>
		<result column="trip_list_serial" property="trip_list_serial"/>
		<result column="place_serial" property="place_serial"/>
		<result column="partner_serial" property="partner_serial"/>
		<result column="trip_name" property="trip_name"/>
			<collection property="p" 
						javaType="bean.PlaceVo">
				<result column="place_serial" property="place_serial"/>
				<result column="place_name" property="place_name"/>
				<result column="place_code" property="place_code"/>
				<result column="place_type" property="place_type"/>
				<result column="place_location" property="place_location"/>
				<result column="reputation" property="reputation"/>
				<result column="review_cnt" property="review_cnt"/>
				<result column="local_code" property="local_code"/>
				<result column="local_name" property="local_name"/>
				<result column="photo_serial" property="photo_serial"/>
				<result column="photo_name" property="photo_name"/>
			</collection>
	</resultMap>
	
		<resultMap id="mp_map_review" type="bean.ReviewVo">
		<result column="review_serial" property="review_serial"/>
		<result column="member_id" property="member_id"/>
		<result column="place_serial" property="place_serial"/>
		<result column="review_type" property="review_type"/>
		<result column="review_title" property="review_title"/>
		<result column="review_content" property="review_content"/>
		<result column="visit_date" property="visit_date"/>
		<result column="review_date" property="review_date"/>
			<collection property="p" 
						javaType="bean.PlaceVo">
				<result column="place_serial" property="place_serial"/>
				<result column="place_name" property="place_name"/>
				<result column="place_code" property="place_code"/>
				<result column="place_type" property="place_type"/>
				<result column="place_location" property="place_location"/>
				<result column="reputation" property="reputation"/>
				<result column="review_cnt" property="review_cnt"/>
				<result column="local_code" property="local_code"/>
				<result column="local_name" property="local_name"/>
				<result column="photo_serial" property="photo_serial"/>
				<result column="photo_name" property="photo_name"/>
			</collection>
	</resultMap>
	
   <insert id="insert_trip" parameterType="bean.TripListVo">
      <selectKey keyProperty="trip_list_serial" resultType="int" order="BEFORE">
         select seq_trip_list_serial.nextval
         from dual
       </selectKey>
      insert into trip_list(trip_list_serial, member_id, trip_name, days_count, start_date, end_date, trip_auth, trip_date) 
      values(#{trip_list_serial}, #{member_id}, #{trip_name}, ${days_count}, #{start_date,jdbcType=DATE}, #{end_date,jdbcType=DATE}, ${trip_auth}, sysdate)
   </insert>
	
	<!-- 전체 여행 리스트 -->
	<select id="select_trip" resultType="bean.TripListVo">
		select 	trip_list_serial, 
				member_id, 
				trip_name, 
				days_count, 
				to_char(start_date,'rrrr/mm/dd') start_date, 
				to_char(end_date,'rrrr/mm/dd') end_date, 
				trip_auth, 
				trip_date 
				from trip_list
				order by trip_date desc
	</select>
	
	<update id="modify_trip" parameterType="bean.TripListVo">
		update trip_list set trip_name = #{trip_name}, 
							 days_count = ${days_count},
							 start_date = #{start_date,jdbcType=DATE},
							 end_date = #{end_date,jdbcType=DATE},
							 trip_auth = ${trip_auth}
							 where trip_list_serial = ${trip_list_serial}
	</update>
	
	<delete id="delete_trip" parameterType="Integer">
		delete from trip_list where trip_list_serial = ${_parameter}
	</delete>
	
	<insert id="insert_like" parameterType="bean.LikeListVo">
      insert into like_list(like_serial, member_id, trip_list_serial, place_serial, partner_serial) 
               values(seq_like_list.nextval, 
               		#{member_id}, 
               		${trip_list_serial}, 
               		${place_serial}, 
               		${partner_serial,jdbcType=NUMERIC} )
   </insert>
   
   
   <!-- 관심여행지 조회 -->
   <select id="select_like" parameterType="String" resultMap="mp_map_like">
  	select like_serial, 
   		   L.member_id, 
   		   T.trip_name, 
   		   place_name,
   		   P.place_serial place_serial,
   		   place_name photo_name, 
   		   T.trip_list_serial, 
   		   P.local_code, 
   		   P.place_code, 
   		   getRevCnt(P.place_serial) review_cnt, 
		   getReputation(P.place_serial) reputation   		   
   		   from trip_list T, place P, like_list L 
   		   where P.place_serial = L.place_serial 
   		   and T.trip_list_serial = L.trip_list_serial 
   		   and L.member_id = #{_parameter}
   </select>
   
   <select id="select_review" parameterType="String" resultMap="mp_map_review">
   		select like_serial,
   			   R.review_serial, 
   			   member_id, 
   			   (select place_name from place where place_serial = R.place_serial) place_name,  
   			   reputation, 
   			   review_title, 
   			   review_content,
			   P.local_code,
			   P.place_code,
			   P.place_name photo_name 			   
   		from review R, review_like L, place P
   		where R.review_serial = L.review_serial
   		and like_id = #{_parameter}
   		and P.place_serial = R.place_serial
   </select>
   
   <!-- like list에서 place serial만 가져오기 -->
   <select id="select_places" parameterType="String" resultType="bean.PlaceVo">
   		select place_serial from like_list where member_id = #{_parameter}
   </select>
   
   <select id="select_profile" parameterType="String" resultType="bean.membershipVo">
   		select member_id, member_city, 
   			   member_web, member_info, nickname,
   			   member_photo, mDate
   		from membership 
   		where member_id = #{_parameter}
   </select>
   
   <select id="select_follow" parameterType="bean.FollowListVo" resultType="Integer">
   		select count(follow_serial)  
   		from follow_list
   		where member_id = #{member_id} 
   		and target_id = #{target_id}
   </select>
   
   <!-- 사진없이 프로필정보만 수정 -->
   <!-- nickname이 프로필 테이블로 넘어오면 수정해야됨 -->
   <update id="modify_profile" parameterType="bean.membershipVo">
   		update membership set member_city = #{member_city},
   						   member_web = #{member_web},
   						   member_info = #{member_info}, 
   						   nickname = #{nickName}
   		where member_id = #{member_id}
   </update>
	
	<!-- 팔로우버튼 눌렀을 때 -->
	<insert id="follow" parameterType="bean.FollowListVo">
		insert into follow_list 
		values(seq_follow_list.nextval, #{member_id}, #{target_id}, systimestamp)
	</insert>
	
	<!-- 팔로우취소 -->
	<delete id="delete_follow" parameterType="bean.FollowListVo">
		delete from follow_list
		where member_id = #{member_id}
		and target_id = #{target_id}
	</delete>
	
	<!-- 팔로워 카운트 -->
	<select id="count_follow" parameterType="String" resultType="Integer">
		select count(follow_serial) from follow_list where member_id = #{_parameter}
	</select>
	
	<!-- 팔로잉 카운트-->
	<select id="count_follower" parameterType="String" resultType="Integer">
		select count(follow_serial) from follow_list where target_id = #{_parameter}
	</select>
	

</mapper>